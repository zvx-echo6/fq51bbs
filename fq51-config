#!/bin/bash
# FQ51BBS Configuration Tool
# Dialog-based TUI for configuration management
# Inspired by femto-config and raspi-config

CONFIG_FILE="${FQ51BBS_CONFIG:-/data/config.toml}"
BACKTITLE="FQ51BBS Configuration"

# Check for dialog
if ! command -v dialog &> /dev/null; then
    echo "Error: 'dialog' is required but not installed."
    echo "Install with: apt install dialog"
    exit 1
fi

# Helper: Read TOML value
get_config() {
    local key="$1"
    grep -E "^${key}\s*=" "$CONFIG_FILE" 2>/dev/null | sed 's/.*=\s*//; s/^"//; s/"$//' | tr -d "'" || echo ""
}

# Helper: Set TOML value
set_config() {
    local key="$1"
    local value="$2"
    local section="$3"

    if grep -q "^${key}\s*=" "$CONFIG_FILE" 2>/dev/null; then
        # Update existing key
        if [[ "$value" =~ ^[0-9]+$ ]] || [[ "$value" == "true" ]] || [[ "$value" == "false" ]]; then
            sed -i "s|^${key}\s*=.*|${key} = ${value}|" "$CONFIG_FILE"
        else
            sed -i "s|^${key}\s*=.*|${key} = \"${value}\"|" "$CONFIG_FILE"
        fi
    else
        # Key doesn't exist - append to section or end
        if [[ -n "$section" ]] && grep -q "^\[${section}\]" "$CONFIG_FILE"; then
            sed -i "/^\[${section}\]/a ${key} = \"${value}\"" "$CONFIG_FILE"
        else
            echo "${key} = \"${value}\"" >> "$CONFIG_FILE"
        fi
    fi
}

# Helper: Show message
msg_box() {
    dialog --backtitle "$BACKTITLE" --title "$1" --msgbox "$2" 10 60
}

# Helper: Yes/No question
yesno() {
    dialog --backtitle "$BACKTITLE" --title "$1" --yesno "$2" 8 60
    return $?
}

# Helper: Input box
input_box() {
    local title="$1"
    local prompt="$2"
    local default="$3"
    dialog --backtitle "$BACKTITLE" --title "$title" --inputbox "$prompt" 10 60 "$default" 3>&1 1>&2 2>&3
}

# Helper: Password box
password_box() {
    local title="$1"
    local prompt="$2"
    dialog --backtitle "$BACKTITLE" --title "$title" --insecure --passwordbox "$prompt" 10 60 3>&1 1>&2 2>&3
}

# Create default config if missing
create_default_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    cat > "$CONFIG_FILE" << 'TOML'
# FQ51BBS Configuration
# Generated by fq51-config

[bbs]
name = "FQ51BBS"
callsign = "FQ51"
admin_password = "changeme"
motd = "Welcome to FQ51BBS!"
max_message_age_days = 30
announcement_interval_hours = 12

[database]
path = "/data/fq51bbs.db"
backup_path = "/data/backups"
backup_interval_hours = 24

[meshtastic]
connection_type = "serial"
serial_port = "/dev/ttyUSB0"
tcp_host = "localhost"
tcp_port = 4403
channel_index = 0
public_channel = 0

[crypto]
argon2_time_cost = 3
argon2_memory_kb = 32768
argon2_parallelism = 1

[features]
mail_enabled = true
boards_enabled = true
sync_enabled = true
registration_enabled = true

[operating_mode]
mode = "full"

[sync]
enabled = true
auto_sync_interval_minutes = 60

[rate_limits]
messages_per_minute = 10
sync_messages_per_minute = 20
commands_per_minute = 30

[logging]
level = "INFO"
TOML
}

# ============== SETUP WIZARD ==============
setup_wizard() {
    # Welcome
    dialog --backtitle "$BACKTITLE" --title "Welcome" --msgbox \
"Welcome to FQ51BBS Setup Wizard!

This wizard will help you configure your BBS.
Press OK to continue." 10 50

    # BBS Name
    local bbs_name
    bbs_name=$(input_box "BBS Identity" "Enter your BBS name:" "FQ51BBS")
    [ $? -ne 0 ] && return
    [ -n "$bbs_name" ] && set_config "name" "$bbs_name" "bbs"

    # Callsign
    local callsign
    callsign=$(input_box "BBS Identity" "Enter your callsign (short identifier):" "FQ51")
    [ $? -ne 0 ] && return
    [ -n "$callsign" ] && set_config "callsign" "$callsign" "bbs"

    # Admin Password
    while true; do
        local password
        password=$(password_box "Admin Password" "Set admin password (min 6 chars):")
        [ $? -ne 0 ] && return

        if [ ${#password} -lt 6 ]; then
            msg_box "Error" "Password must be at least 6 characters."
            continue
        fi

        local confirm
        confirm=$(password_box "Confirm Password" "Confirm admin password:")
        [ $? -ne 0 ] && return

        if [ "$password" != "$confirm" ]; then
            msg_box "Error" "Passwords do not match. Try again."
            continue
        fi

        set_config "admin_password" "$password" "bbs"
        break
    done

    # Meshtastic Connection
    local conn_type
    conn_type=$(dialog --backtitle "$BACKTITLE" --title "Meshtastic Connection" \
        --menu "How is your Meshtastic device connected?" 12 50 3 \
        "serial" "USB Serial (e.g., /dev/ttyUSB0)" \
        "tcp" "TCP Network (e.g., 192.168.1.100)" \
        "skip" "Skip - configure later" \
        3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    case $conn_type in
        serial)
            set_config "connection_type" "serial" "meshtastic"
            local port
            port=$(input_box "Serial Port" "Enter serial port:" "/dev/ttyUSB0")
            [ -n "$port" ] && set_config "serial_port" "$port" "meshtastic"
            ;;
        tcp)
            set_config "connection_type" "tcp" "meshtastic"
            local host
            host=$(input_box "TCP Host" "Enter Meshtastic host:" "localhost")
            [ -n "$host" ] && set_config "tcp_host" "$host" "meshtastic"
            local tcp_port
            tcp_port=$(input_box "TCP Port" "Enter TCP port:" "4403")
            [ -n "$tcp_port" ] && set_config "tcp_port" "$tcp_port" "meshtastic"
            ;;
    esac

    # Operating Mode
    local op_mode
    op_mode=$(dialog --backtitle "$BACKTITLE" --title "Operating Mode" \
        --menu "Select operating mode:" 14 50 4 \
        "full" "Full - Mail and bulletin boards" \
        "mail_only" "Mail Only - Private messages only" \
        "boards_only" "Boards Only - Public bulletins only" \
        "repeater" "Repeater - Relay messages only" \
        3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return
    [ -n "$op_mode" ] && set_config "mode" "$op_mode" "operating_mode"

    # Features
    if yesno "Features" "Enable user registration?"; then
        set_config "registration_enabled" "true" "features"
    else
        set_config "registration_enabled" "false" "features"
    fi

    if yesno "Features" "Enable inter-BBS sync?"; then
        set_config "sync_enabled" "true" "features"
        set_config "enabled" "true" "sync"
    else
        set_config "sync_enabled" "false" "features"
        set_config "enabled" "false" "sync"
    fi

    msg_box "Setup Complete" "Configuration saved to:\n$CONFIG_FILE\n\nYou can now start FQ51BBS."
}

# ============== BBS SETTINGS ==============
bbs_settings() {
    while true; do
        local name=$(get_config "name")
        local callsign=$(get_config "callsign")
        local motd=$(get_config "motd")
        local max_age=$(get_config "max_message_age_days")
        local announce=$(get_config "announcement_interval_hours")

        local choice
        choice=$(dialog --backtitle "$BACKTITLE" --title "BBS Settings" \
            --menu "Configure BBS settings:" 16 60 7 \
            "1" "BBS Name: $name" \
            "2" "Callsign: $callsign" \
            "3" "Admin Password: ********" \
            "4" "MOTD: ${motd:0:30}..." \
            "5" "Message Expiration: $max_age days" \
            "6" "Announcement Interval: $announce hours" \
            "B" "Back to Main Menu" \
            3>&1 1>&2 2>&3)
        [ $? -ne 0 ] && return

        case $choice in
            1)
                local new_name
                new_name=$(input_box "BBS Name" "Enter BBS name:" "$name")
                [ -n "$new_name" ] && set_config "name" "$new_name" "bbs"
                ;;
            2)
                local new_call
                new_call=$(input_box "Callsign" "Enter callsign:" "$callsign")
                [ -n "$new_call" ] && set_config "callsign" "$new_call" "bbs"
                ;;
            3)
                local new_pass
                new_pass=$(password_box "Admin Password" "Enter new admin password:")
                if [ -n "$new_pass" ]; then
                    local confirm
                    confirm=$(password_box "Confirm" "Confirm password:")
                    if [ "$new_pass" = "$confirm" ]; then
                        set_config "admin_password" "$new_pass" "bbs"
                        msg_box "Success" "Password updated."
                    else
                        msg_box "Error" "Passwords do not match."
                    fi
                fi
                ;;
            4)
                local new_motd
                new_motd=$(input_box "MOTD" "Enter welcome message:" "$motd")
                [ -n "$new_motd" ] && set_config "motd" "$new_motd" "bbs"
                ;;
            5)
                local new_age
                new_age=$(input_box "Message Expiration" "Days to keep messages:" "$max_age")
                [ -n "$new_age" ] && set_config "max_message_age_days" "$new_age" "bbs"
                ;;
            6)
                local new_ann
                new_ann=$(input_box "Announcements" "Hours between announcements (0=disable):" "$announce")
                [ -n "$new_ann" ] && set_config "announcement_interval_hours" "$new_ann" "bbs"
                ;;
            B|b) return ;;
        esac
    done
}

# ============== MESHTASTIC SETTINGS ==============
meshtastic_settings() {
    while true; do
        local conn_type=$(get_config "connection_type")
        local serial_port=$(get_config "serial_port")
        local tcp_host=$(get_config "tcp_host")
        local tcp_port=$(get_config "tcp_port")
        local channel=$(get_config "channel_index")

        local choice
        choice=$(dialog --backtitle "$BACKTITLE" --title "Meshtastic Settings" \
            --menu "Configure Meshtastic connection:" 14 60 5 \
            "1" "Connection Type: $conn_type" \
            "2" "Serial Port: $serial_port" \
            "3" "TCP Host: $tcp_host" \
            "4" "TCP Port: $tcp_port" \
            "5" "Channel Index: $channel" \
            "B" "Back to Main Menu" \
            3>&1 1>&2 2>&3)
        [ $? -ne 0 ] && return

        case $choice in
            1)
                local new_type
                new_type=$(dialog --backtitle "$BACKTITLE" --title "Connection Type" \
                    --menu "Select connection type:" 10 40 2 \
                    "serial" "USB Serial" \
                    "tcp" "TCP Network" \
                    3>&1 1>&2 2>&3)
                [ -n "$new_type" ] && set_config "connection_type" "$new_type" "meshtastic"
                ;;
            2)
                local new_port
                new_port=$(input_box "Serial Port" "Enter serial port:" "$serial_port")
                [ -n "$new_port" ] && set_config "serial_port" "$new_port" "meshtastic"
                ;;
            3)
                local new_host
                new_host=$(input_box "TCP Host" "Enter TCP host:" "$tcp_host")
                [ -n "$new_host" ] && set_config "tcp_host" "$new_host" "meshtastic"
                ;;
            4)
                local new_tcp_port
                new_tcp_port=$(input_box "TCP Port" "Enter TCP port:" "$tcp_port")
                [ -n "$new_tcp_port" ] && set_config "tcp_port" "$new_tcp_port" "meshtastic"
                ;;
            5)
                local new_chan
                new_chan=$(input_box "Channel" "Enter channel index:" "$channel")
                [ -n "$new_chan" ] && set_config "channel_index" "$new_chan" "meshtastic"
                ;;
            B|b) return ;;
        esac
    done
}

# ============== OPERATING MODE ==============
operating_mode_settings() {
    local current_mode=$(get_config "mode")

    local new_mode
    new_mode=$(dialog --backtitle "$BACKTITLE" --title "Operating Mode" \
        --default-item "$current_mode" \
        --menu "Select operating mode:" 14 55 4 \
        "full" "Full - Mail and bulletin boards" \
        "mail_only" "Mail Only - Private messages only" \
        "boards_only" "Boards Only - Public bulletins only" \
        "repeater" "Repeater - Relay messages only" \
        3>&1 1>&2 2>&3)

    [ -n "$new_mode" ] && set_config "mode" "$new_mode" "operating_mode"
}

# ============== FEATURES ==============
features_settings() {
    local mail=$(get_config "mail_enabled")
    local boards=$(get_config "boards_enabled")
    local sync=$(get_config "sync_enabled")
    local reg=$(get_config "registration_enabled")

    # Convert to on/off for checklist
    [[ "$mail" == "true" ]] && mail="on" || mail="off"
    [[ "$boards" == "true" ]] && boards="on" || boards="off"
    [[ "$sync" == "true" ]] && sync="on" || sync="off"
    [[ "$reg" == "true" ]] && reg="on" || reg="off"

    local choices
    choices=$(dialog --backtitle "$BACKTITLE" --title "Features" \
        --checklist "Enable/disable features:" 12 50 4 \
        "mail" "Private Mail" "$mail" \
        "boards" "Bulletin Boards" "$boards" \
        "sync" "Inter-BBS Sync" "$sync" \
        "registration" "User Registration" "$reg" \
        3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Update config based on selections
    [[ "$choices" == *"mail"* ]] && set_config "mail_enabled" "true" "features" || set_config "mail_enabled" "false" "features"
    [[ "$choices" == *"boards"* ]] && set_config "boards_enabled" "true" "features" || set_config "boards_enabled" "false" "features"
    [[ "$choices" == *"sync"* ]] && set_config "sync_enabled" "true" "features" || set_config "sync_enabled" "false" "features"
    [[ "$choices" == *"registration"* ]] && set_config "registration_enabled" "true" "features" || set_config "registration_enabled" "false" "features"

    msg_box "Features Updated" "Feature settings have been saved."
}

# ============== SYNC SETTINGS ==============
sync_settings() {
    while true; do
        local enabled=$(get_config "enabled")
        local interval=$(get_config "auto_sync_interval_minutes")
        local mail_mode=$(get_config "mail_delivery_mode")

        local choice
        choice=$(dialog --backtitle "$BACKTITLE" --title "Sync Settings" \
            --menu "Configure inter-BBS sync:" 12 55 4 \
            "1" "Sync Enabled: $enabled" \
            "2" "Sync Interval: $interval minutes" \
            "3" "Mail Delivery: ${mail_mode:-instant}" \
            "B" "Back to Main Menu" \
            3>&1 1>&2 2>&3)
        [ $? -ne 0 ] && return

        case $choice in
            1)
                if yesno "Sync" "Enable inter-BBS sync?"; then
                    set_config "enabled" "true" "sync"
                else
                    set_config "enabled" "false" "sync"
                fi
                ;;
            2)
                local new_int
                new_int=$(input_box "Sync Interval" "Minutes between sync:" "$interval")
                [ -n "$new_int" ] && set_config "auto_sync_interval_minutes" "$new_int" "sync"
                ;;
            3)
                local new_mode
                new_mode=$(dialog --backtitle "$BACKTITLE" --title "Mail Delivery" \
                    --menu "Mail delivery mode:" 10 40 2 \
                    "instant" "Instant - Send immediately" \
                    "batched" "Batched - Queue and send periodically" \
                    3>&1 1>&2 2>&3)
                [ -n "$new_mode" ] && set_config "mail_delivery_mode" "$new_mode" "sync"
                ;;
            B|b) return ;;
        esac
    done
}

# ============== VIEW CONFIG ==============
view_config() {
    dialog --backtitle "$BACKTITLE" --title "Current Configuration" \
        --textbox "$CONFIG_FILE" 20 70
}

# ============== MAIN MENU ==============
main_menu() {
    while true; do
        local choice
        choice=$(dialog --backtitle "$BACKTITLE" --title "Main Menu" \
            --cancel-label "Exit" \
            --menu "FQ51BBS Configuration" 16 50 8 \
            "1" "Setup Wizard" \
            "2" "BBS Settings" \
            "3" "Meshtastic Connection" \
            "4" "Operating Mode" \
            "5" "Features" \
            "6" "Sync Settings" \
            "7" "View Configuration" \
            "X" "Exit" \
            3>&1 1>&2 2>&3)

        [ $? -ne 0 ] && break

        case $choice in
            1) setup_wizard ;;
            2) bbs_settings ;;
            3) meshtastic_settings ;;
            4) operating_mode_settings ;;
            5) features_settings ;;
            6) sync_settings ;;
            7) view_config ;;
            X|x) break ;;
        esac
    done

    clear
    echo "Configuration saved to: $CONFIG_FILE"
    echo "Run 'docker compose up -d' to start FQ51BBS"
}

# ============== ENTRY POINT ==============

# Create config if missing
if [ ! -f "$CONFIG_FILE" ]; then
    create_default_config
fi

# Parse command line
case "${1:-}" in
    --wizard|-w)
        setup_wizard
        clear
        ;;
    --show|-s)
        cat "$CONFIG_FILE"
        ;;
    --help|-h)
        echo "FQ51BBS Configuration Tool"
        echo ""
        echo "Usage: fq51-config [OPTION]"
        echo ""
        echo "Options:"
        echo "  --wizard, -w    Run setup wizard"
        echo "  --show, -s      Show current configuration"
        echo "  --help, -h      Show this help"
        echo ""
        echo "Without options, opens the interactive menu."
        ;;
    *)
        main_menu
        ;;
esac
