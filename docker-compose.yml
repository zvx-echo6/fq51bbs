# FQ51BBS Docker Compose Configuration
#
# Usage:
#   cp config.example.toml config.toml
#   # Edit config.toml with your settings
#   docker-compose up -d
#
# For serial connection (USB), add device mapping in service definition
# For TCP connection, ensure Meshtastic device is accessible on network

version: "3.8"

services:
  fq51bbs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    image: fq51bbs:latest
    container_name: fq51bbs
    restart: unless-stopped

    # Uncomment for USB serial connection to Meshtastic device
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #   - /dev/ttyACM0:/dev/ttyACM0

    volumes:
      # Configuration file (read-only)
      - ./config.toml:/app/config.toml:ro

      # Persistent data (database, backups)
      - fq51bbs_data:/data

      # Logs (optional - can also use docker logs)
      - fq51bbs_logs:/var/log

    environment:
      # Override config file location if needed
      - FQ51BBS_CONFIG=/app/config.toml

      # For TCP connection to Meshtastic
      # - MESHTASTIC_HOST=192.168.1.100
      # - MESHTASTIC_PORT=4403

    # Limit resources for RPi compatibility
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; sqlite3.connect('/data/fq51bbs.db').execute('SELECT 1')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Web reader interface (read-only access)
  fq51bbs-web:
    build:
      context: .
      dockerfile: Dockerfile
    image: fq51bbs:latest
    container_name: fq51bbs-web
    restart: unless-stopped
    profiles:
      - web  # Only start with: docker-compose --profile web up

    command: ["python", "-m", "fq51bbs.web"]

    volumes:
      - ./config.toml:/app/config.toml:ro
      - fq51bbs_data:/data:ro  # Read-only access to database

    ports:
      - "8080:8080"

    depends_on:
      - fq51bbs

    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  fq51bbs_data:
    name: fq51bbs_data
  fq51bbs_logs:
    name: fq51bbs_logs

# Network for service communication
networks:
  default:
    name: fq51bbs_network
