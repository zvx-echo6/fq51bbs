# FQ51BBS Docker Compose Configuration
#
# Usage:
#   docker compose run --rm fq51bbs fq51-config      # Config menu (dialog TUI)
#   docker compose run --rm fq51bbs fq51-config -w   # Setup wizard
#   docker compose up -d                              # Run BBS in background
#   docker compose --profile config up -d             # Enable web config (port 7681)
#
# Config is stored in the fq51bbs_data volume at /data/config.toml
#
# For serial connection (USB), uncomment the devices section below
# For TCP connection, configure via the setup wizard

services:
  fq51bbs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    image: fq51bbs:latest
    container_name: fq51bbs
    restart: unless-stopped

    # Uncomment for USB serial connection to Meshtastic device
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #   - /dev/ttyACM0:/dev/ttyACM0

    volumes:
      # Persistent data (database, config, backups)
      - fq51bbs_data:/data

      # Logs (optional - can also use docker logs)
      - fq51bbs_logs:/var/log

    # Run interactively for first-time setup wizard
    stdin_open: true
    tty: true

    # Limit resources for RPi compatibility
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; sqlite3.connect('/data/fq51bbs.db').execute('SELECT 1')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Web-based configuration terminal (ttyd)
  fq51bbs-config:
    image: tsl0922/ttyd:latest
    container_name: fq51bbs-config
    restart: unless-stopped
    profiles:
      - config  # Start with: docker compose --profile config up -d
    command: ["-W", "ttyd", "-p", "7681", "-t", "fontSize=16", "-t", "theme={'background':'#1a1a2e','foreground':'#00ff00'}", "docker", "exec", "-it", "fq51bbs", "fq51-config"]
    ports:
      - "7681:7681"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - fq51bbs
    deploy:
      resources:
        limits:
          memory: 64M

  # Optional: Web reader interface (read-only access)
  fq51bbs-web:
    build:
      context: .
      dockerfile: Dockerfile
    image: fq51bbs:latest
    container_name: fq51bbs-web
    restart: unless-stopped
    profiles:
      - web  # Only start with: docker-compose --profile web up

    command: ["python", "-m", "fq51bbs.web", "--config", "/data/config.toml"]

    volumes:
      - fq51bbs_data:/data:ro  # Read-only access to database and config

    ports:
      - "8080:8080"

    depends_on:
      - fq51bbs

    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  fq51bbs_data:
    name: fq51bbs_data
  fq51bbs_logs:
    name: fq51bbs_logs

# Network for service communication
networks:
  default:
    name: fq51bbs_network
